<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Pokemon 1v1 battle</title>
      <style>
         :root {
            --gap_size: 0.25rem;
            --button_height: 2.5rem;
            --border_radius: 0.65rem;
         }

         @font-face {
            font-family: "PixelifySans";
            src: url("/static/font/PixelifySans.ttf") format("truetype");
         }

         *, *::before, *::after {
            box-sizing: border-box;
            font-optical-sizing: auto;
            font-family: "PixelifySans", sans-serif;
            font-size: 1.25rem;
         }

         html, body {
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100dvw;
         }

         main {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            image-rendering: pixelated;
            background: url("/static/img/battle_background.jpg");
            background-size: cover;
            background-position: bottom;
            background-repeat: no-repeat;
            position: relative;
         }

         main > img {
            position: absolute;
            image-rendering: pixelated;
         }

         #first_pokemon_sprite {
            transform: translateX(-50%);
            left: 30%;
            bottom: 20%;
         }

         #second_pokemon_sprite {
            transform: translateX(50%) translateY(-100%);
            right: 37.5%;
            top: 55%;
         }

         #top_controls {
            display: flex;
            flex-direction: row;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--button_height);
         }

         #top_controls button {
            width: 100%;
            height: var(--button_height);
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: var(--border_radius);
            margin: var(--gap_size);
            color: white;
            background: rgba(0, 0, 0, 0.75);
            transition: background 0.1s ease-in-out;
            border: none;
            cursor: pointer;
         }

         #top_controls button:hover {
            background: rgba(165, 165, 165, 0.85);
         }

         #prediction_controls {
            display: flex;
            position: absolute;
            flex-direction: column;
            align-items: center;
            width: min-content;
            gap: var(--gap_size);
            top: calc(var(--button_height) + 2 * var(--gap_size));
            left: 0;
         }

         #prediction_results {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            gap: var(--gap_size);
         }

         #stats_first_pokemon, #stats_second_pokemon {
            position: absolute;
            width: 25%;
            height: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 1.25rem;
            border-radius: var(--border_radius);
            transition: transform 0.4s ease-in-out;
         }

         #stats_first_pokemon.hidden {
            transform: translate(-100%, 100%);
         }
         #stats_second_pokemon.hidden {
            transform: translate(100%, 100%);
         }

         #stats_first_pokemon img, #stats_second_pokemon img {
            image-rendering: optimizeQuality;
            width: auto;
            height: 100%;
         }

         #stats_first_pokemon {
            left: 0;
            bottom: 0;
         }

         #stats_second_pokemon {
            right: 0;
            bottom: 0;
         }
      </style>
   </head>
   <body>
      <main>
         <img id="first_pokemon_sprite"></img>
         <img id="second_pokemon_sprite"></img>
         <section id="top_controls">
            <button id="btn_stats">Stats</button>
            <button id="btn_create_custom_pkmn">Create Pokemon</button>
         </section>
         <section id="prediction_controls">
            <form>
               <select id="model_file">
                  {% for model in models %}
                     <option value="{{ model }}">{{ model }}</option>
                  {% endfor %}
               </select>
               <select id="pokemon_first">
                  {% for pokemon in pokemon_choices %}
                     <option value="{{ pokemon }}">{{ pokemon }}</option>
                  {% endfor %}
               </select>
               <select id="pokemon_second">
                  {% for pokemon in pokemon_choices %}
                     <option value="{{ pokemon }}">{{ pokemon }}</option>
                  {% endfor %}
               </select>
            </form>
         </section>
         <section id="prediction_results">
            <h2 id="winner_element"></h2>
            <h2 id="confidence_element"></h2>
         </section>
         <section id="stats_first_pokemon">
            <img id="stats_first_pokemon_radial"></img>
         </section>
         <section id="stats_second_pokemon">
            <img id="stats_second_pokemon_radial"></img>
         </section>
      </main>
      <script>
         const btn_stats = document.getElementById('btn_stats');
         const btn_create_custom_pkmn = document.getElementById('btn_create_custom_pkmn');

         const select_model = document.getElementById('model_file');
         const select_first = document.getElementById('pokemon_first');
         const select_second = document.getElementById('pokemon_second');

         const first_pokemon_sprite = document.getElementById('first_pokemon_sprite');
         const second_pokemon_sprite = document.getElementById('second_pokemon_sprite');

         const stats_first_pokemon_radial = document.getElementById('stats_first_pokemon_radial');
         const stats_second_pokemon_radial = document.getElementById('stats_second_pokemon_radial');

         const stats_first_pokemon_container = document.getElementById('stats_first_pokemon');
         const stats_second_pokemon_container = document.getElementById('stats_second_pokemon');

         const winner_element = document.getElementById('winner_element');
         const confidence_element = document.getElementById('confidence_element');

         // Function to calculate the prediction of the battle outcome
         const calculatePrediction = async () => {
            // Get the pokemon choices
            const p1 = select_first.value;
            const p2 = select_second.value;
            // Check valid values
            if (!p1 || !p2) {
               winner_element.innerHTML = "";
               confidence_element.innerHTML = "";
               return;
            }
            // Set the pokemon sprites
            first_pokemon_sprite.src = `/static/img/sprites/${p1}_F.gif`;
            second_pokemon_sprite.src = `/static/img/sprites/${p2}_S.gif`;
            first_pokemon_sprite.alt = `${p1} From Behind`;
            second_pokemon_sprite.alt = `${p2} From Front`;
            // Update the stats graphs
            updateStatGraphs();
            try {
               // Fetch the prediction from the server
               const resp = fetch("/precdict_battle", {
                  method: "POST",
                  headers: {
                     "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                     pokemon_first: p1,
                     pokemon_second: p2,
                  }),
               }).then(async response => {
                  if (!response.ok) {
                     throw new Error("Network response was not OK");
                  }
                  data = await response.json();
                  winner_element.innerHTML = `Winner: ${data.winner}`;
                  confidence_element.innerHTML = `Confidence: ${data.confidence.toFixed(2)}%`;
               });
            } catch (err) {
               console.error("Error fetching prediction: ", err);
               winner_element.innerHTML = "";
               confidence_element.innerHTML = "";
            }
         };

         const updateStatGraphs = async () => {
            // Get the pokemon choices
            const p1 = select_first.value;
            const p2 = select_second.value;
            // Check valid values
            if (!p1 || !p2) {
               stats_first_pokemon_radial.src = "";
               stats_second_pokemon_radial.src = "";
               return;
            }
            stats_first_pokemon_radial.src = `/pokemon/${p1}/radial_stats.png`;
            stats_second_pokemon_radial.src = `/pokemon/${p2}/radial_stats.png`;
         };

         const updateUi = async () => {
            updateStatGraphs();
            calculatePrediction();
         };

         // Calculate the initial prediction
         updateUi();

         // Add event listeners to the images to set their size
         [first_pokemon_sprite, second_pokemon_sprite].forEach((sprite) => {
            sprite.addEventListener('load', () => {
               sprite.width = sprite.naturalWidth * 3;
               sprite.height = sprite.naturalHeight * 3;
            })
         });

         // Add event listeners to the pokemon selects to predict the battle outcome
         [select_first, select_second].forEach((e) => {
            e.addEventListener('change', calculatePrediction);
         });

         // Set model choice from the server
         select_model.addEventListener('change', async () => {
            // Get the model choice
            const model_name = select_model.value;
            // Check valid value
            if (!model_name) {
               return;
            }
            try {
               // Change server model
               const resp = await fetch("/change_model", {
                  method: "POST",
                  headers: {
                     "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                     model_file: model_name,
                  }),
               }).then(async response => {
                  if (!response.ok) {
                     throw new Error("Network response was not OK");
                  }
                  console.log("Model changed successfully to: ", model_name);
               });
            } catch (err) {
               console.error("Error changing model: ", err);
            }
         });

         btn_stats.addEventListener('click', () => {
            stats_first_pokemon_container.classList.toggle('hidden');
            stats_second_pokemon_container.classList.toggle('hidden');
         });
      </script>
   </body>
</html>